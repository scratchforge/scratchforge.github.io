export const session12 = {
    title: "Startup Code (Reset Handler)",
    content: `<style>.firmware-lesson{padding:0;margin:0}.firmware-lesson h2{color:#e74c3c;margin-top:40px;margin-bottom:20px;font-size:1.8em;border-left:5px solid #e74c3c;padding-left:15px}.hero-box{background:linear-gradient(135deg,rgba(231,76,60,0.1) 0%,rgba(192,57,43,0.1) 100%);border-radius:15px;padding:30px;margin:30px 0;text-align:center;border:2px solid rgba(231,76,60,0.2)}.info-box{background:#f8f9fa;border-left:5px solid #e74c3c;padding:20px;margin:25px 0;border-radius:8px}.cards-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0}.info-card{background:linear-gradient(135deg,rgba(231,76,60,0.08) 0%,rgba(192,57,43,0.08) 100%);padding:25px;border-radius:12px;border:2px solid rgba(231,76,60,0.2);transition:all 0.3s ease}.info-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(231,76,60,0.2)}.card-icon{font-size:50px;margin-bottom:15px;display:block}.info-card h4{color:#e74c3c;margin-bottom:10px;font-size:1.2em}.firmware-lesson p{color:#333;margin-bottom:15px;font-size:1.05em;line-height:1.7}.firmware-lesson ul{margin:15px 0 15px 25px}.code-box{background:#1e1e1e;color:#d4d4d4;padding:20px;border-radius:10px;margin:20px 0;font-family:monospace;overflow-x:auto;font-size:14px}.quiz-box{background:#fff9e6;padding:25px;border-radius:15px;margin-top:30px;border:3px solid #ffd700}.fun-fact{background:#e8f5e9;border-left:5px solid #4caf50;padding:20px;margin:25px 0;border-radius:8px}</style><div class="firmware-lesson"><div class="hero-box"><div style="font-size:60px;margin-bottom:15px">üöÄ</div><p>Reset Handler: The first code that runs when your MCU powers on!</p></div><h2>üéØ What is the Reset Handler?</h2><p>The <strong>Reset_Handler</strong> is the first function called after power-on or reset. It's responsible for initializing the C runtime environment before main() can run.</p><div class="info-box"><strong>Reset Handler Responsibilities:</strong><ul><li>Copy .data section from Flash to RAM</li><li>Zero .bss section in RAM</li><li>Call SystemInit() for clock/peripheral setup</li><li>Call static constructors (C++)</li><li>Call main()</li><li>Handle main() return (infinite loop)</li></ul></div><h2>üíª Complete Reset Handler Implementation</h2><div class="code-box">/* startup.c - Reset Handler */<br><br>#include <stdint.h><br><br>/* Linker script symbols */<br>extern uint32_t _sidata;  /* Start of .data in Flash */<br>extern uint32_t _sdata;   /* Start of .data in RAM */<br>extern uint32_t _edata;   /* End of .data in RAM */<br>extern uint32_t _sbss;    /* Start of .bss */<br>extern uint32_t _ebss;    /* End of .bss */<br><br>/* External functions */<br>extern int main(void);<br>extern void SystemInit(void);<br><br>void Reset_Handler(void) {<br>    uint32_t *src, *dst;<br>    <br>    /* 1. Copy .data section from Flash to RAM */<br>    src = &_sidata;  /* Source in Flash (LMA) */<br>    dst = &_sdata;   /* Destination in RAM (VMA) */<br>    <br>    while (dst < &_edata) {<br>        *dst++ = *src++;<br>    }<br>    <br>    /* 2. Zero .bss section */<br>    dst = &_sbss;<br>    while (dst < &_ebss) {<br>        *dst++ = 0;<br>    }<br>    <br>    /* 3. Call system initialization (optional) */<br>    SystemInit();<br>    <br>    /* 4. Call main() */<br>    main();<br>    <br>    /* 5. If main() returns, loop forever */<br>    while(1);<br>}</div><h2>üìã Step-by-Step Breakdown</h2><div class="code-box">/* Step 1: Copy .data from Flash to RAM */<br><br>/* Why? .data contains initialized global variables.<br>   Initial values are stored in Flash (non-volatile).<br>   But variables must run from RAM (writable). */<br><br>src = &_sidata;  /* 0x08001000 (Flash) */<br>dst = &_sdata;   /* 0x20000000 (RAM) */<br><br>while (dst < &_edata) {<br>    *dst++ = *src++;  /* Copy word by word */<br>}<br><br>/* Example:<br>   int global_var = 42;  // Initial value in Flash<br>   After copy, global_var is in RAM with value 42<br>*/</div><div class="code-box">/* Step 2: Zero .bss section */<br><br>/* Why? .bss contains uninitialized variables.<br>   C standard requires they start at zero.<br>   No Flash storage needed - just zero RAM. */<br><br>dst = &_sbss;  /* 0x20000100 (RAM) */<br><br>while (dst < &_ebss) {<br>    *dst++ = 0;  /* Write zero */<br>}<br><br>/* Example:<br>   int buffer[256];  // Uninitialized<br>   After zeroing, all elements are 0<br>*/</div><h2>‚öôÔ∏è SystemInit Function</h2><div class="code-box">/* system.c - System initialization */<br><br>void SystemInit(void) {<br>    /* 1. Configure Flash latency for high speed */<br>    FLASH->ACR |= FLASH_ACR_LATENCY_5WS;<br>    <br>    /* 2. Enable FPU (Cortex-M4) */<br>    SCB->CPACR |= (0xF << 20);  /* CP10 & CP11 full access */<br>    <br>    /* 3. Configure system clock (optional here) */<br>    /* Usually done in main() or separate function */<br>    <br>    /* 4. Enable instruction and data cache */<br>    SCB_EnableICache();<br>    SCB_EnableDCache();<br>}</div><h2>üéØ Optimized Reset Handler</h2><div class="code-box">/* Optimized version with word-aligned copy */<br><br>void Reset_Handler(void) {<br>    uint32_t *src = &_sidata;<br>    uint32_t *dst = &_sdata;<br>    <br>    /* Copy .data (word-aligned) */<br>    uint32_t size = (uint32_t)&_edata - (uint32_t)&_sdata;<br>    uint32_t words = size / 4;<br>    <br>    for (uint32_t i = 0; i < words; i++) {<br>        dst[i] = src[i];<br>    }<br>    <br>    /* Zero .bss (word-aligned) */<br>    dst = &_sbss;<br>    size = (uint32_t)&_ebss - (uint32_t)&_sbss;<br>    words = size / 4;<br>    <br>    for (uint32_t i = 0; i < words; i++) {<br>        dst[i] = 0;<br>    }<br>    <br>    /* System init */<br>    SystemInit();<br>    <br>    /* Call main */<br>    main();<br>    <br>    /* Infinite loop */<br>    while(1);<br>}</div><h2>üöÄ Assembly-Optimized Version</h2><div class="code-box">/* Using memcpy/memset (if available) */<br><br>#include <string.h><br><br>void Reset_Handler(void) {<br>    uint32_t data_size = (uint32_t)&_edata - (uint32_t)&_sdata;<br>    uint32_t bss_size = (uint32_t)&_ebss - (uint32_t)&_sbss;<br>    <br>    /* Copy .data */<br>    memcpy(&_sdata, &_sidata, data_size);<br>    <br>    /* Zero .bss */<br>    memset(&_sbss, 0, bss_size);<br>    <br>    SystemInit();<br>    main();<br>    while(1);<br>}</div><h2>üîß C++ Support (Static Constructors)</h2><div class="code-box">/* For C++ projects */<br><br>typedef void (*func_ptr)(void);<br><br>extern func_ptr __init_array_start;<br>extern func_ptr __init_array_end;<br><br>void Reset_Handler(void) {<br>    /* Copy .data and zero .bss */<br>    /* ... */<br>    <br>    /* Call static constructors */<br>    func_ptr *p;<br>    for (p = &__init_array_start; p < &__init_array_end; p++) {<br>        (*p)();<br>    }<br>    <br>    /* Call main */<br>    main();<br>    <br>    /* Call static destructors (if main returns) */<br>    /* Usually not needed in embedded */<br>    <br>    while(1);<br>}</div><h2>üìä Complete Startup File</h2><div class="code-box">/* startup_stm32f407.c - Complete example */<br><br>#include <stdint.h><br><br>/* Linker symbols */<br>extern uint32_t _estack;<br>extern uint32_t _sidata, _sdata, _edata;<br>extern uint32_t _sbss, _ebss;<br><br>/* Functions */<br>extern int main(void);<br>extern void SystemInit(void);<br><br>void Reset_Handler(void);<br>void Default_Handler(void);<br><br>/* Weak handlers */<br>void NMI_Handler(void) __attribute__((weak, alias("Default_Handler")));<br>void HardFault_Handler(void) __attribute__((weak, alias("Default_Handler")));<br>/* ... more handlers ... */<br><br>/* Vector table */<br>__attribute__((section(".isr_vector")))<br>void (* const g_pfnVectors[])(void) = {<br>    (void (*)(void))((uint32_t)&_estack),<br>    Reset_Handler,<br>    NMI_Handler,<br>    HardFault_Handler,<br>    /* ... */<br>};<br><br>/* Reset Handler Implementation */<br>void Reset_Handler(void) {<br>    uint32_t *src = &_sidata;<br>    uint32_t *dst = &_sdata;<br>    <br>    /* Copy .data */<br>    while (dst < &_edata) {<br>        *dst++ = *src++;<br>    }<br>    <br>    /* Zero .bss */<br>    dst = &_sbss;<br>    while (dst < &_ebss) {<br>        *dst++ = 0;<br>    }<br>    <br>    /* System init */<br>    SystemInit();<br>    <br>    /* Call main */<br>    main();<br>    <br>    /* Loop forever */<br>    while(1);<br>}<br><br>/* Default Handler */<br>void Default_Handler(void) {<br>    while(1);<br>}</div><h2>üîç Debugging Reset Handler</h2><div class="code-box">/* Debug version with LED blink */<br><br>#define LED_PIN 5<br>#define GPIOA_MODER (*(volatile uint32_t*)0x40020000)<br>#define GPIOA_ODR   (*(volatile uint32_t*)0x40020014)<br>#define RCC_AHB1ENR (*(volatile uint32_t*)0x40023830)<br><br>void Reset_Handler(void) {<br>    /* Enable GPIOA clock */<br>    RCC_AHB1ENR |= (1 << 0);<br>    <br>    /* Set PA5 as output */<br>    GPIOA_MODER |= (1 << (LED_PIN * 2));<br>    <br>    /* Blink LED to show we're alive */<br>    for (int i = 0; i < 3; i++) {<br>        GPIOA_ODR |= (1 << LED_PIN);<br>        for (volatile int j = 0; j < 100000; j++);<br>        GPIOA_ODR &= ~(1 << LED_PIN);<br>        for (volatile int j = 0; j < 100000; j++);<br>    }<br>    <br>    /* Continue with normal startup */<br>    /* Copy .data, zero .bss, etc. */<br>}</div><div class="fun-fact"><strong>üåü First Code:</strong><p style="margin-top:10px;margin-bottom:0">The Reset_Handler is literally the FIRST C code that runs on your microcontroller! Before this, only the hardware has been active. After reset, the processor loads the stack pointer from address 0x00, then jumps to the address at 0x04 (Reset_Handler). Everything starts here!</p></div><div class="quiz-box"><h3>üß† Test Your Knowledge!</h3><p><strong>Question:</strong> Why must .data be copied from Flash to RAM?</p><ul><li>A) Flash is slower than RAM</li><li>B) Variables must be writable ‚úì</li><li>C) To save Flash space</li><li>D) For security reasons</li></ul><p style="margin-top:15px"><em>Answer: B - Variables need to be in RAM because they must be writable!</em></p></div></div>`,
    questions: [{ q: "Why must .data be copied from Flash to RAM?", options: ["Flash is slower than RAM", "Variables must be writable", "To save Flash space", "For security reasons"], answer: 1 }],
    tools: [{ name: "Startup Code Generator", type: "interactive", description: "Generate startup code for different MCUs" }]
};
